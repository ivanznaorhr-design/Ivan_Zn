<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hajduci – karta</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html,body,#map{height:100%;margin:0}
    .toolbar{
      position:fixed;z-index:1000;left:8px;top:8px;
      background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.2);
      padding:8px 10px;font-family:system-ui,-apple-system,Roboto,Arial,sans-serif;font-size:14px;max-width:92vw
    }
    .toolbar select,.toolbar input{margin:4px 0;width:220px}
    .status{margin-top:4px;font-size:12px;color:#444}
    .legend{position:fixed;right:8px;bottom:8px;background:#fff;padding:6px 8px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.2);font-size:12px}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px}
    .popup-title{font-weight:700;margin-bottom:4px}
    textarea{font-family:inherit;font-size:13px}
    button{border:1px solid #ddd;background:#f9f9f9;border-radius:8px}
  </style>
</head>
<body>
<div class="toolbar">
  <div><b>Hajduci – karta</b></div>
  <label>Razdoblje:
    <select id="period">
      <option value="">Sva</option>
      <option>Prapovijest</option>
      <option>Antika</option>
      <option>Srednji vijek</option>
      <option>Osmansko razdoblje</option>
      <option>Habsburško razdoblje</option>
      <option>Kasna antika / rani srednji vijek</option>
      <option>Srednji vijek / Novovjekovno</option>
      <option>Granično doba</option>
      <option>17.–18. st.</option>
      <option>Novi vijek</option>
    </select>
  </label><br/>
  <label>Kategorija:
    <select id="cat">
      <option value="">Sve</option>
      <option>Gradina</option>
      <option>Gradina/utvrda</option>
      <option>Tumuli/Gomile</option>
      <option>Tumul</option>
      <option>Gomila</option>
      <option>Stećci</option>
      <option>Sakralno</option>
      <option>Antika</option>
      <option>Pećina/špilja</option>
      <option>Špilja/Sklonište</option>
      <option>Stražara</option>
      <option>Stražara/vidikovac</option>
      <option>Most/Prijelaz</option>
      <option>Infrastruktura</option>
      <option>Ruta/Prijelaz</option>
      <option>Logistika</option>
      <option>Sklonište/logistika</option>
      <option>Događaj</option>
      <option>Događaj (zasjeda)</option>
      <option>Memorijal/Spomen</option>
      <option>Legenda/Hajduci</option>
      <option>Granični kamen</option>
      <option>Kontrola putova</option>
      <option>Rani slojevi</option>
    </select>
  </label><br/>
  <input id="q" placeholder="Pretraži naziv/opis/izvor…"/>
  <div class="status" id="status">Učitavam…</div>
  <div style="margin-top:6px">
    <button id="btnLog"    style="padding:6px 10px">Dnevnik</button>
    <button id="btnExport" style="padding:6px 10px">Izvoz JSON</button>
    <button id="btnClear"  style="padding:6px 10px">Obriši sve</button>
  </div>
</div>

<div id="map"></div>

<div class="legend">
  <div><span class="dot" style="background:#d91e18"></span>Gradina</div>
  <div><span class="dot" style="background:#8e44ad"></span>Tumul/Gomila</div>
  <div><span class="dot" style="background:#2c3e50"></span>Stećci</div>
  <div><span class="dot" style="background:#7f8c8d"></span>Špilja</div>
  <div><span class="dot" style="background:#2980b9"></span>Stražara</div>
  <div><span class="dot" style="background:#34495e"></span>Prijelaz/Most</div>
  <div><span class="dot" style="background:#e67e22"></span>Događaj/zasjeda</div>
  <div><span class="dot" style="background:#f39c12"></span>Legenda</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // Karta
  const map = L.map('map',{zoomControl:true}).setView([43.4467, 17.2169], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap'}).addTo(map);

  // Helperi
  const statusEl = document.getElementById('status') || { textContent: '' };
  function featureKey(f){
    const p=f.properties||{};
    if(p.id) return `site:${p.id}`;
    const [lng,lat]=(f.geometry||{}).coordinates||[0,0];
    return `site:${(p.name||'noname').trim()}|${lat.toFixed(6)},${lng.toFixed(6)}`;
  }
  function loadState(k){ try{return JSON.parse(localStorage.getItem(k)||'{}')}catch(e){return{}} }
  function saveState(k,o){ localStorage.setItem(k,JSON.stringify(o)) }

  const colorByCat = c => ({
    'Gradina':'#d91e18','Gradina/utvrda':'#d91e18',
    'Tumuli/Gomile':'#8e44ad','Tumul':'#8e44ad','Gomila':'#8e44ad',
    'Stećci':'#2c3e50','Sakralno':'#16a085','Antika':'#27ae60',
    'Pećina/špilja':'#7f8c8d','Špilja/Sklonište':'#7f8c8d',
    'Stražara':'#2980b9','Stražara/vidikovac':'#2980b9',
    'Most/Prijelaz':'#34495e','Infrastruktura':'#34495e','Ruta/Prijelaz':'#34495e',
    'Logistika':'#9b59b6','Sklonište/logistika':'#9b59b6',
    'Događaj':'#e67e22','Događaj (zasjeda)':'#e67e22',
    'Memorijal/Spomen':'#95a5a6','Legenda/Hajduci':'#f39c12',
    'Granični kamen':'#b9770e','Kontrola putova':'#b9770e',
    'Rani slojevi':'#1abc9c'
  }[c]||'#34495e');

  function markerStyle(cat,done=false){
    return { radius:7, color: done?'#2ecc71':'#ffffff', weight:2, fillColor:colorByCat(cat), fillOpacity:0.95 };
  }

  function checklistHTML(key,p){
    const st = loadState(key);
    const c = n => (st[n]?'checked':''); const v = n => (st[n]||'');
    const src = p.source || p.src || '';
    return `
      <div class="popup-title">${p.name||'Nepoznato'}</div>
      <div><b>Kategorija:</b> ${p.category||'-'} | <b>Razdoblje:</b> ${p.period||'-'}</div>
      ${p.desc?`<div class="popup-desc" style="margin-top:6px">${p.desc}</div>`:''}
      ${p.why? `<div style="margin-top:6px"><b>Zašto važno:</b> ${p.why}</div>`:''}
      ${p.evidence? `<div><b>Dokaz:</b> ${p.evidence}</div>`:''}
      ${p.importance? `<div><b>Važnost:</b> ${p.importance}/5</div>`:''}
      ${p.confidence? `<div><b>Vjerodostojnost:</b> ${p.confidence}</div>`:''}
      ${p.next_steps? `<div><b>Sljedeći koraci:</b> ${p.next_steps}</div>`:''}
      ${src? `<div style="margin-top:6px"><small><b>Izvor:</b> ${src}</small></div>`:''}
      <hr style="margin:8px 0">
      <div><b>Checklist (offline):</b></div>
      <label><input type="checkbox" data-k="${key}" data-f="seen"    ${c('seen')}> Viđeno</label><br>
      <label><input type="checkbox" data-k="${key}" data-f="photo"   ${c('photo')}> Foto</label><br>
      <label><input type="checkbox" data-k="${key}" data-f="ceramic" ${c('ceramic')}> Keramika</label><br>
      <label><input type="checkbox" data-k="${key}" data-f="metal"   ${c('metal')}> Metal</label><br>
      <label><input type="checkbox" data-k="${key}" data-f="char"    ${c('char')}> Ugljen / ognjište</label>
      <div style="margin-top:6px">
        <label>Bilješka:</label><br>
        <textarea data-k="${key}" data-f="note" rows="3" style="width:100%">${v('note')}</textarea>
      </div>
      <div style="margin-top:6px">
        <label>Ocjena vjerodostojnosti (lokalno):</label><br>
        <select data-k="${key}" data-f="confLocal" style="width:100%">
          <option value="">—</option>
          <option ${v('confLocal')==='low'?'selected':''}   value="low">low</option>
          <option ${v('confLocal')==='medium'?'selected':''}value="medium">medium</option>
          <option ${v('confLocal')==='high'?'selected':''}  value="high">high</option>
        </select>
      </div>
    `;
  }

  function attachPopupHandlers(container, key, layer, p){
    container.querySelectorAll('input[type=checkbox], textarea, select').forEach(el=>{
      el.addEventListener('change', ()=>{
        const st = loadState(key);
        const f = el.getAttribute('data-f');
        if (el.type === 'checkbox') st[f] = el.checked; else st[f] = el.value;
        st.updatedAt = new Date().toISOString();
        saveState(key, st);
        const done = !!(st.seen||st.photo||st.ceramic||st.metal||st.char||(st.note||'').trim());
        layer.setStyle && layer.setStyle( markerStyle(p.category, done) );
      });
    });
  }

  let ALL=null, LAYER=null;
  const catSel=document.getElementById('cat'), perSel=document.getElementById('period'), qInput=document.getElementById('q');

  function passFilters(f){
    const p=f.properties||{};
    const cat=(catSel&&catSel.value)?catSel.value.toLowerCase():'';
    const per=(perSel&&perSel.value)?perSel.value.toLowerCase():'';
    const q  =(qInput&&qInput.value)?qInput.value.toLowerCase():'';
    const okC=!cat || ((p.category||'').toLowerCase()===cat);
    const okP=!per || ((p.period||'').toLowerCase()===per);
    const hay=((p.name||'')+' '+(p.desc||'')+' '+(p.why||'')+' '+(p.evidence||'')+' '+(p.source||'')+' '+(p.src||'')).toLowerCase();
    const okQ=!q || hay.includes(q);
    return okC&&okP&&okQ;
  }

  function render(){
    if(!ALL) return;
    if(LAYER) map.removeLayer(LAYER);
    const feats = ALL.features.filter(passFilters);
    LAYER = L.geoJSON({type:'FeatureCollection',features:feats},{
      pointToLayer:(f,latlng)=>{
        const key=featureKey(f), p=f.properties||{}, st=loadState(key);
        const done=!!(st.seen||st.photo||st.ceramic||st.metal||st.char||(st.note||'').trim());
        return L.circleMarker(latlng, markerStyle(p.category, done));
      },
      onEachFeature:(f,layer)=>{
        const key=featureKey(f), p=f.properties||{};
        const html=checklistHTML(key,p);
        layer.bindPopup(html);
        layer.on('popupopen', e=>{
          const c=e.popup.getElement(); if(c) attachPopupHandlers(c,key,layer,p);
        });
      }
    }).addTo(map);
    if(feats.length){ const b=LAYER.getBounds(); if(b.isValid()) map.fitBounds(b.pad(0.2)); }
    statusEl.textContent = `Točaka (filter): ${feats.length} / ${ALL.features.length}`;
  }

  function collectLog(){
    const out=[];
    (ALL?.features||[]).forEach(f=>{
      const key=featureKey(f), st=loadState(key);
      if(Object.keys(st).length){
        out.push({
          key, name:(f.properties||{}).name||'', category:(f.properties||{}).category||'',
          period:(f.properties||{}).period||'', lat:f.geometry.coordinates[1], lng:f.geometry.coordinates[0],
          state:st
        });
      }
    });
    return out;
  }

  document.getElementById('btnLog').onclick = ()=>{ const d=collectLog(); alert(`Zapisano stavki: ${d.length}`); };
  document.getElementById('btnExport').onclick = ()=>{
    const data=collectLog();
    const blob=JSON.stringify({exportedAt:new Date().toISOString(),entries:data},null,2);
    const overlay=document.createElement('div');
    overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000;display:flex;align-items:center;justify-content:center;';
    overlay.innerHTML=`<div style="background:#fff;width:92%;max-width:900px;max-height:80%;padding:12px;border-radius:10px;overflow:auto;font:13px monospace">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <b>Izvoz JSON (kopiraj)</b><button id="ovClose" style="padding:6px 10px">Zatvori</button>
      </div><pre style="white-space:pre-wrap">${blob.replace(/[<>&]/g,s=>({ '<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</pre></div>`;
    document.body.appendChild(overlay);
    overlay.querySelector('#ovClose').onclick=()=>overlay.remove();
  };
  document.getElementById('btnClear').onclick = ()=>{
    if(!confirm('Obrisati SVE lokalne zapise check-liste?')) return;
    (ALL?.features||[]).forEach(f=> localStorage.removeItem(featureKey(f)));
    alert('Obrisano.'); render();
  };

  async function loadData(){
    statusEl.textContent='Učitavam točke…';
    try{
      const r=await fetch('sites.geojson');
      ALL=await r.json();
      statusEl.textContent='Točke učitane.'; render();
    }catch(e){
      console.error(e); statusEl.textContent='Nema sites.geojson – demo točka.';
      ALL={type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Point',coordinates:[17.2169,43.4467]},properties:{name:'Topana (demo)',category:'Gradina',period:'Srednji vijek',desc:'Demo točka.'}}]};
      render();
    }
  }
  document.getElementById('cat')?.addEventListener('change',render);
  document.getElementById('period')?.addEventListener('change',render);
  document.getElementById('q')?.addEventListener('input',()=>{clearTimeout(window._t);window._t=setTimeout(render,200);});
  loadData();
</script>
</body>
</html>
