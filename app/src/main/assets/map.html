<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Hajduci – karta</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html,body,#map{height:100%;margin:0}
    .toolbar{
      position:fixed;z-index:1000;left:8px;top:8px;
      background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.2);
      padding:8px 10px;font-family:system-ui,-apple-system,Roboto,Arial,sans-serif;font-size:14px
    }
    .toolbar select,.toolbar input{margin:4px 0;width:220px}
    .status{margin-top:4px;font-size:12px;color:#444}
    .popup-title{font-weight:700;margin-bottom:4px}
    .popup-desc{margin-top:4px}
    .legend{position:fixed;right:8px;bottom:8px;background:#fff;padding:6px 8px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.2);font-size:12px}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px}
  </style>
</head>
<body>
<div class="toolbar">
  <div><b>Hajduci – karta</b></div>
  <label>Razdoblje:
    <select id="periodSel">
      <option value="">Sva</option>
      <option>Prapovijest</option>
      <option>Antika</option>
      <option>Srednji vijek</option>
      <option>Osmansko razdoblje</option>
      <option>Habsburško razdoblje</option>
    </select>
  </label><br/>
  <label>Kategorija:
    <select id="catSel">
      <option value="">Sve</option>
      <option>Gradina</option>
      <option>Nalazište</option>
      <option>Kula/stražara</option>
      <option>Bitka/događaj</option>
      <option>Legenda/Hajduci</option>
    </select>
  </label><br/>
  <input id="q" placeholder="Pretraži naziv/opis…"/>
  <div class="status" id="status">Učitavam…</div>
</div>

<div id="map"></div>

<div class="legend">
  <div><span class="dot" style="background:#d91e18"></span>Gradina</div>
  <div><span class="dot" style="background:#2ecc71"></span>Nalazište</div>
  <div><span class="dot" style="background:#2980b9"></span>Kula/stražara</div>
  <div><span class="dot" style="background:#8e44ad"></span>Događaj</div>
  <div><span class="dot" style="background:#f39c12"></span>Legenda</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map',{zoomControl:true}).setView([43.446,17.214], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'&copy; OpenStreetMap'
}).addTo(map);

// boje po kategoriji
const colorByCat = c => ({
  'Gradina':'#d91e18',
  'Nalazište':'#2ecc71',
  'Kula/stražara':'#2980b9',
  'Bitka/događaj':'#8e44ad',
  'Legenda/Hajduci':'#f39c12'
}[c] || '#34495e');

let all = [];
let layer = L.layerGroup().addTo(map);

function render(){
  layer.clearLayers();
  const per = document.getElementById('periodSel').value.trim().toLowerCase();
  const cat = document.getElementById('catSel').value.trim().toLowerCase();
  const q   = document.getElementById('q').value.trim().toLowerCase();

  const feats = all.filter(f=>{
    const p=f.properties||{};
    const okPer = !per || (p.period||'').toLowerCase()===per;
    const okCat = !cat || (p.category||'').toLowerCase()===cat;
    const hay = ((p.name||'')+' '+(p.desc||'')).toLowerCase();
    const okQ = !q || hay.includes(q);
    return okPer && okCat && okQ;
  });

  feats.forEach(f=>{
    const [lng,lat]=f.geometry.coordinates;
    const p=f.properties||{};
    const m=L.circleMarker([lat,lng],{
      radius:7, weight:2, color:'#fff', fillColor:colorByCat(p.category), fillOpacity:0.95
    }).bindPopup(
      `<div class="popup-title">${p.name||'(bez naziva)'}</div>
       <div><b>Kategorija:</b> ${p.category||'-'}</div>
       <div><b>Razdoblje:</b> ${p.period||'-'}</div>
       ${p.src?`<div><a href="${p.src}" target="_blank">Izvor</a></div>`:''}
       ${p.desc?`<div class="popup-desc">${p.desc}</div>`:''}`
    );
    m.addTo(layer);
  });

  document.getElementById('status').textContent =
    `Točaka: ${feats.length} / ${all.length}`;
  if (feats.length) {
    const b=L.featureGroup(layer.getLayers()).getBounds();
    if (b.isValid()) map.fitBounds(b.pad(0.2));
  }
}

document.getElementById('periodSel').onchange = render;
document.getElementById('catSel').onchange = render;
document.getElementById('q').oninput = ()=>{ clearTimeout(window._t); window._t=setTimeout(render,200); };

(async ()=>{
  const status = document.getElementById('status');
  try{
    status.textContent='Učitavam točke…';
    const r = await fetch('sites.geojson');
    if (!r.ok) throw new Error('HTTP '+r.status);
    const gj = await r.json();
    all = gj.features||[];
    status.textContent='Točke učitane.';
    render();
  }catch(e){
    // fallback demo podaci ako nema sites.geojson
    all = [{
      "type":"Feature","geometry":{"type":"Point","coordinates":[17.2153,43.4476]},
      "properties":{"name":"Gradina – Imotski","category":"Gradina","period":"Srednji vijek","desc":"Ostaci utvrde iznad grada."}
    },{
      "type":"Feature","geometry":{"type":"Point","coordinates":[17.2011,43.4468]},
      "properties":{"name":"Kula stražara","category":"Kula/stražara","period":"Osmansko razdoblje","desc":"Stražarska točka na prijelazu."}
    },{
      "type":"Feature","geometry":{"type":"Point","coordinates":[17.2308,43.4419]},
      "properties":{"name":"Legenda o hajducima","category":"Legenda/Hajduci","period":"Habsburško razdoblje","desc":"Predaja o zasjedi.","src":"https://example.com"}
    }];
    status.textContent='Nije nađen sites.geojson – prikazujem demo točke.';
    render();
  }
})();
</script>
</body>
</html>
