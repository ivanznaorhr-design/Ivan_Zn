<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hajduci – karta</title>

  <!-- Leaflet CSS BEZ integrity -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, Roboto, Arial, sans-serif;
    }

    /* Toolbar preko vrha */
    .toolbar-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 950;
      background: rgba(255,255,255,0.98);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 8px 10px 6px 10px;
      box-sizing: border-box;
    }

    .toolbar-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .toolbar-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 4px;
    }

    .toolbar-row label {
      font-size: 14px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .toolbar-row select,
    .toolbar-row input[type="text"] {
      font-size: 14px;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      min-width: 160px;
    }

    .toolbar-row input[type="text"] {
      min-width: 220px;
    }

    #status {
      font-size: 13px;
      margin-left: auto;
      white-space: nowrap;
    }

    /* Zoom kontrole – dolje lijevo, potpuno vidljive */
    .leaflet-control-zoom {
      position: absolute !important;
      left: 10px !important;
      bottom: 40px !important;
      top: auto !important;
      right: auto !important;
      z-index: 950;
    }

    /* Legenda – dolje desno preko karte */
    .legend-overlay {
      position: absolute;
      right: 10px;
      bottom: 10px;
      background: rgba(255,255,255,0.95);
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 12px;
      line-height: 1.4;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      z-index: 950;
    }

    .legend-overlay .dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 4px;
      vertical-align: -1px;
    }
  </style>
</head>
<body>
  <div class="toolbar-overlay">
    <div class="toolbar-title">Hajduci – karta</div>

    <div class="toolbar-row">
      <label>
        Razdoblje:
        <select id="periodFilter">
          <option value="">Sva</option>
          <option value="Prapovijest">Prapovijest</option>
          <option value="Antika">Antika</option>
          <option value="Rani srednji vijek">Rani srednji vijek</option>
          <option value="Srednji vijek">Srednji vijek</option>
          <option value="Osmansko razdoblje">Osmansko razdoblje</option>
          <option value="Mletačko razdoblje">Mletačko razdoblje</option>
          <option value="Novi vijek">Novi vijek</option>
        </select>
      </label>

      <label>
        Kategorija:
        <select id="categoryFilter">
          <option value="">Sve</option>
          <option value="Gradine / utvrde">Gradine / utvrde</option>
          <option value="Tumuli / gomile">Tumuli / gomile</option>
          <option value="Pećine / skloništa">Pećine / skloništa</option>
          <option value="Stećci / nekropole">Stećci / nekropole</option>
          <option value="Bitke / zasjede">Bitke / zasjede</option>
          <option value="Logistika / karavani / hanovi">Logistika / karavani / hanovi</option>
          <option value="Putevi / mostovi / prijelazi">Putevi / mostovi / prijelazi</option>
          <option value="Stražare / vidikovci">Stražare / vidikovci</option>
          <option value="Memorijal / spomenici">Memorijal / spomenici</option>
          <option value="Događaji / priče">Događaji / priče</option>
          <option value="Ostalo / neizvjesno">Ostalo / neizvjesno</option>
        </select>
      </label>
    </div>

    <div class="toolbar-row">
      <label style="flex:1">
        Pretraži:
        <input id="searchFilter" type="text" placeholder="naziv, opis, izvor…" />
      </label>
      <span id="status">Učitavam točke…</span>
    </div>
  </div>

  <div id="map"></div>

  <div id="legend" class="legend-overlay">
    <b>Legenda</b><br/>
    <span class="dot" style="background:#d91e18"></span> Gradine / utvrde<br/>
    <span class="dot" style="background:#e67e22"></span> Tumuli / gomile<br/>
    <span class="dot" style="background:#16a085"></span> Pećine / skloništa<br/>
    <span class="dot" style="background:#9b59b6"></span> Stećci / nekropole<br/>
    <span class="dot" style="background:#c0392b"></span> Bitke / zasjede<br/>
    <span class="dot" style="background:#f39c12"></span> Logistika / karavani / hanovi<br/>
    <span class="dot" style="background:#2980b9"></span> Putevi / mostovi / prijelazi<br/>
    <span class="dot" style="background:#34495e"></span> Stražare / vidikovci<br/>
    <span class="dot" style="background:#7f8c8d"></span> Memorijal / spomenici<br/>
    <span class="dot" style="background:#2ecc71"></span> Događaji / priče<br/>
    <span class="dot" style="background:#95a5a6"></span> Ostalo / neizvjesno<br/>
  </div>

  <!-- Leaflet JS BEZ integrity -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const statusEl    = document.getElementById('status');
    const periodSel   = document.getElementById('periodFilter');
    const catSel      = document.getElementById('categoryFilter');
    const searchInput = document.getElementById('searchFilter');

    const colorByGroup = {
      'Gradine / utvrde'              : '#d91e18',
      'Tumuli / gomile'               : '#e67e22',
      'Pećine / skloništa'            : '#16a085',
      'Stećci / nekropole'            : '#9b59b6',
      'Bitke / zasjede'               : '#c0392b',
      'Logistika / karavani / hanovi' : '#f39c12',
      'Putevi / mostovi / prijelazi'  : '#2980b9',
      'Stražare / vidikovci'          : '#34495e',
      'Memorijal / spomenici'         : '#7f8c8d',
      'Događaji / priče'              : '#2ecc71',
      'Ostalo / neizvjesno'           : '#95a5a6'
    };

    let ALL   = null;
    let LAYER = null;

    function featureGroup(p){
      const c = (p.category || p.cat || '').toLowerCase();

      if(/gradin|utvrd|tvrđav|tvrda|kula|kaštel|kastel|burg/.test(c))
        return 'Gradine / utvrde';

      if(/tum|gomil|humak|gromil/.test(c))
        return 'Tumuli / gomile';

      if(/pećin|špilj|spilj|jama/.test(c))
        return 'Pećine / skloništa';

      if(/steć|nekropol|groblj|grob/.test(c))
        return 'Stećci / nekropole';

      if(/bitk|zasjed|boj/.test(c))
        return 'Bitke / zasjede';

      if(/karavan|logistik|han|stanic|baza|magacin/.test(c))
        return 'Logistika / karavani / hanovi';

      if(/rimski put|via|cest|put|most|prijelaz|prilaz/.test(c))
        return 'Putevi / mostovi / prijelazi';

      if(/stražar|straža|vidikov/.test(c))
        return 'Stražare / vidikovci';

      if(/spomen|memorijal|monument/.test(c))
        return 'Memorijal / spomenici';

      if(/dogadj|događ|priča|legend|napad|pljačk/.test(c))
        return 'Događaji / priče';

      return 'Ostalo / neizvjesno';
    }

    function markerStyle(p){
      const group = featureGroup(p);
      const fill  = colorByGroup[group] || '#95a5a6';
      return {
        radius: 8,
        color: '#ffffff',
        weight: 2,
        fillColor: fill,
        fillOpacity: 0.96
      };
    }

    function popupHtml(p){
      const name   = p.name   || '(bez naziva)';
      const period = p.period || '';
      const group  = featureGroup(p);
      const desc   = p.desc   || '';
      const why    = p.why    || '';
      const evid   = p.evidence || '';
      const next   = p.next_steps || '';
      const prob   = p.confidence || p.importance || '';

      return (
        '<b>' + name + '</b><br/>' +
        (period ? '<i>' + period + '</i><br/>' : '') +
        (group  ? '<b>Kategorija:</b> ' + group + '<br/>' : '') +
        (desc   ? desc + '<br/>' : '') +
        (evid   ? '<b>Dokazi:</b> ' + evid + '<br/>' : '') +
        (why    ? '<b>Zašto ovdje:</b> ' + why + '<br/>' : '') +
        (prob   ? '<b>Vjerojatnost pronalaska:</b> ' + prob + '<br/>' : '') +
        (next   ? '<b>Sljedeći koraci:</b> ' + next : '')
      );
    }

    function passFilters(f){
      const p = f.properties || {};
      const periodFilter = periodSel.value || '';
      const catFilter    = catSel.value || '';
      const text         = (searchInput.value || '').toLowerCase().trim();

      if (periodFilter && (p.period || '') !== periodFilter) return false;

      const grp = featureGroup(p);
      if (catFilter && grp !== catFilter) return false;

      if (text) {
        const hay = (
          (p.name || '') + ' ' +
          (p.desc || '') + ' ' +
          (p.source || '') + ' ' +
          (p.why || '')
        ).toLowerCase();
        if (!hay.includes(text)) return false;
      }
      return true;
    }

    function render(){
      if (!ALL) return;
      if (LAYER) {
        map.removeLayer(LAYER);
      }

      const feats = ALL.features.filter(passFilters);

      LAYER = L.geoJSON(
        { type: 'FeatureCollection', features: feats },
        {
          pointToLayer: function (f, latlng) {
            return L.circleMarker(latlng, markerStyle(f.properties || {}));
          },
          onEachFeature: function (f, layer) {
            layer.bindPopup(popupHtml(f.properties || {}));
          }
        }
      ).addTo(map);

      if (feats.length) {
        try {
          map.fitBounds(LAYER.getBounds(), { padding: [40, 40] });
        } catch (e) {}
      }

      var total = ALL.features.length;
      statusEl.textContent = 'Točaka (filter): ' + feats.length + ' / ' + total;
    }

    function attachHandlers(){
      periodSel.addEventListener('change', render);
      catSel.addEventListener('change', render);
      searchInput.addEventListener('input', function () {
        clearTimeout(window.__searchTimer);
        window.__searchTimer = setTimeout(render, 200);
      });
    }

    // inicijalizacija karte + učitavanje podataka
    var map = L.map('map', { zoomControl: true }).setView([43.4, 17.2], 9);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap suradnici'
    }).addTo(map);

    function loadData(){
      statusEl.textContent = 'Učitavam točke…';
      fetch('sites.geojson?v=' + Date.now())
        .then(function (r){ return r.json(); })
        .then(function (json){
          ALL = json;
          attachHandlers();
          render();
        })
        .catch(function (e){
          console.log(e);
          statusEl.textContent = 'Greška pri učitavanju točaka.';
        });
    }

    loadData();
  </script>
</body>
</html>
